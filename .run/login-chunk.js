(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[626],{37788:function(e,t,s){Promise.resolve().then(s.bind(s,38991))},38991:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return l}});var r=s(57437),n=s(2265),a=s(99376),i=s(27648),o=s(4431);function l(){let e=(0,a.useRouter)(),{login:t,isAuthenticated:s,loading:l}=(0,o.a)(),[c,u]=(0,n.useState)("admin@ridepulse.com"),[h,d]=(0,n.useState)("admin123"),[m,f]=(0,n.useState)(null),[g,y]=(0,n.useState)(!1);(0,n.useEffect)(()=>{!l&&s&&e.replace("/")},[l,s,e]);let p=async s=>{s.preventDefault(),f(null),y(!0);try{await t(c,h),e.replace("/")}catch(e){f(e instanceof Error?e.message:"Login failed")}finally{y(!1)}};return(0,r.jsx)("main",{className:"min-h-screen bg-gray-50 flex items-center justify-center px-4",children:(0,r.jsxs)("div",{className:"w-full max-w-md bg-white border border-gray-200 rounded-xl p-6",children:[(0,r.jsx)("h1",{className:"text-2xl font-semibold text-gray-900",children:"Вход в RidePulse"}),(0,r.jsx)("p",{className:"text-sm text-gray-500 mt-1",children:"Используйте аккаунт API Gateway"}),(0,r.jsxs)("form",{className:"mt-6 space-y-4",onSubmit:p,children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),(0,r.jsx)("input",{type:"email",value:c,onChange:e=>u(e.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2",required:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),(0,r.jsx)("input",{type:"password",value:h,onChange:e=>d(e.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2",required:!0})]}),m&&(0,r.jsx)("p",{className:"text-sm text-red-600",children:m}),(0,r.jsx)("button",{type:"submit",disabled:g,className:"w-full bg-gray-900 text-white rounded-lg py-2 font-medium disabled:opacity-60",children:g?"Вход...":"Войти"})]}),(0,r.jsxs)("p",{className:"text-sm text-gray-600 mt-4",children:["Нет аккаунта?"," ",(0,r.jsx)(i.default,{href:"/register",className:"text-gray-900 underline",children:"Регистрация"})]})]})})}},4431:function(e,t,s){"use strict";s.d(t,{H:function(){return h},a:function(){return d}});var r=s(57437),n=s(2265);let a="".concat(window.location.protocol,"//").concat(window.location.hostname,":3000")||0,i="ridepulse_access_token",o="ridepulse_refresh_token";class l{getAccessToken(){return localStorage.getItem(i)}getRefreshToken(){return localStorage.getItem(o)}setTokens(e){localStorage.setItem(i,e.accessToken),localStorage.setItem(o,e.refreshToken)}clearTokens(){localStorage.removeItem(i),localStorage.removeItem(o)}getStoredTokens(){return{accessToken:this.getAccessToken(),refreshToken:this.getRefreshToken()}}async refreshAccessToken(){if(this.isRefreshing&&this.refreshPromise)return this.refreshPromise;let e=this.getRefreshToken();return e?(this.isRefreshing=!0,this.refreshPromise=(async()=>{try{let t=await fetch("".concat(this.baseUrl,"/api/auth/refresh"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e})});if(!t.ok)return this.clearTokens(),null;let s=await t.json();if(!s.accessToken)return this.clearTokens(),null;return localStorage.setItem(i,s.accessToken),s.accessToken}catch(e){return this.clearTokens(),null}finally{this.isRefreshing=!1,this.refreshPromise=null}})(),this.refreshPromise):null}async request(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s="".concat(this.baseUrl).concat(e),r=new Headers(t.headers||{});if(r.set("Content-Type","application/json"),!t.skipAuth){let e=this.getAccessToken();e&&r.set("Authorization","Bearer ".concat(e))}let n=await fetch(s,{...t,headers:r});if(401===n.status&&!t.skipAuth){let e=await this.refreshAccessToken();e&&(r.set("Authorization","Bearer ".concat(e)),n=await fetch(s,{...t,headers:r}))}if(!n.ok){let e=await n.json().catch(()=>({}));throw Error(e.error||e.message||"HTTP ".concat(n.status))}return n.json()}async login(e,t){let s=await this.request("/api/auth/login",{method:"POST",body:JSON.stringify({email:e,password:t}),skipAuth:!0});return this.setTokens(s.tokens),s}async register(e){let t=await this.request("/api/auth/register",{method:"POST",body:JSON.stringify(e),skipAuth:!0});return this.setTokens(t.tokens),t}async me(){return(await this.request("/api/auth/me")).user}async getRiders(){return(await this.request("/api/riders")).riders}async getRider(e){return this.request("/api/riders/".concat(e))}async createRider(e){return this.request("/api/riders",{method:"POST",body:JSON.stringify(e)})}async getActiveSessions(){return this.request("/api/sessions/active")}async getSession(e){return this.request("/api/sessions/".concat(e))}async getSessionHistory(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;return this.request("/api/riders/".concat(e,"/sessions?limit=").concat(t))}constructor(e){this.isRefreshing=!1,this.refreshPromise=null,this.baseUrl=e}}let c=new l(a),u=(0,n.createContext)(void 0);function h(e){let{children:t}=e,[s,a]=(0,n.useState)(null),[i,o]=(0,n.useState)(!0),[l,h]=(0,n.useState)(null),d=()=>{let{accessToken:e}=c.getStoredTokens();h(e)},m=async()=>{let{accessToken:e,refreshToken:t}=c.getStoredTokens();if(!e&&!t){o(!1);return}try{let e=await c.me();a(e),d()}catch(e){c.clearTokens(),a(null),h(null)}finally{o(!1)}};(0,n.useEffect)(()=>{m()},[]);let f=async(e,t)=>{a((await c.login(e,t)).user),d()},g=async e=>{a((await c.register(e)).user),d()},y=()=>{c.clearTokens(),a(null),h(null)},p=async()=>{a(await c.me()),d()},k=(0,n.useMemo)(()=>({user:s,loading:i,isAuthenticated:!!s,accessToken:l,login:f,register:g,logout:y,refreshUser:p}),[s,i,l]);return(0,r.jsx)(u.Provider,{value:k,children:t})}function d(){let e=(0,n.useContext)(u);if(!e)throw Error("useAuth must be used inside AuthProvider");return e}}},function(e){e.O(0,[448,971,117,744],function(){return e(e.s=37788)}),_N_E=e.O()}]);
